<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Legal-Tech Explorer — Soft Dashboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#eaf4f8; --panel:#ffffff; --muted:#5b6c7b; --text:#102a43; --accent:#22b8c3;
    --border:#d0e2ea; --chip:#d9f2f4; --chip-text:#056674; --shadow:0 10px 30px rgba(16,42,67,.1);
    --scroll-thumb:#0b3a6e; --scroll-thumb-hover:#0d4a8e; --scroll-track:#ddeaf3;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:transparent;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}

  header{position:sticky;top:0;z-index:20;background:var(--panel);border-bottom:1px solid var(--border);box-shadow:0 2px 10px rgba(17,24,39,.04)}
  .topbar{display:flex;align-items:center;gap:12px;padding:12px 16px;max-width:1400px;margin:0 auto}
  .brand{display:flex;align-items:center;gap:10px}
  .brand-logo{height:22px}
  h1{margin:0;font-size:16px;font-weight:700;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:12px}
  .spacer{flex:1}
  .btn{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);font-weight:600;cursor:pointer;transition:.2s}
  .btn:hover{box-shadow:0 6px 16px rgba(2,6,23,.07)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent);color:#fff;border-color:transparent}

  .wrap{display:grid;gap:16px;padding:16px;max-width:1400px;margin:0 auto;min-height:calc(100vh - 64px);grid-template-columns:1fr}
  body.state-filters .wrap{grid-template-columns:300px 1fr}
  body.state-right .wrap{grid-template-columns:1fr 420px}
  body.state-right.state-right-wide .wrap{grid-template-columns:1fr 720px}

  aside.left, aside.right, main{min-height:0}
  aside.left, aside.right{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px}
  aside.left{display:none} aside.right{display:none}
  body.state-filters aside.left{display:flex} body.state-right aside.right{display:flex}
  main{display:flex;flex-direction:column;gap:16px}
  .toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px}
  .col-title{font-size:12px;font-weight:800;letter-spacing:.28px;text-transform:uppercase;color:var(--muted)}
  .box{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .box.alt{background:linear-gradient(180deg,#fff,#fafbff)}

  .filters details.group{background:#fafbff;border:1px solid var(--border);border-radius:12px;padding:10px;margin:10px 0}
  .filters details.group>summary{cursor:pointer;list-style:none;font-weight:700}
  .filter-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .filter-field{display:flex;flex-direction:column;gap:6px;margin:8px 0}
  .filter-field label{font-size:12px;color:var(--muted)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--chip-text);border:1px solid #dbe2fe;font-weight:600}
  input[type="search"], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;outline:none}
  input[type="search"]:focus, select:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(99,102,241,.15)}

  #tools.tools{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .tool{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:10px;transition:.2s}
  .tool:hover{box-shadow:0 14px 32px rgba(2,6,23,.08);transform:translateY(-1px)}
  .tool-head{display:flex;align-items:center;gap:12px}
  .title{font-weight:700;font-size:15px}
  .meta{color:var(--muted);font-size:12px}
  .desc{color:#374151;font-size:13px}
  .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:4px}
  .logo{width:48px;height:48px;object-fit:contain;border-radius:10px;background:#f8fafc;border:1px solid var(--border);padding:6px}
  .logo-badge{display:flex;align-items:center;justify-content:center;font-weight:800;color:#334155;background:#eef2ff;border:1px solid #dbe2fe;border-radius:12px;width:48px;height:48px}

  .left, main, .right{overflow:auto;outline:none;max-height:calc(100vh - 80px)}

  /* Landing card is lightly translucent so aurora shows through */
  #aiLanding{
    position:fixed;inset:0;
    background:rgba(255,255,255,0.78);
    backdrop-filter: blur(6px) saturate(1.05);
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;z-index:10;padding:16px
  }

  /* Tabs in right sidebar */
  .tabs{display:flex;align-items:center;gap:6px}
  .tab{padding:6px 10px;border:1px solid var(--border);background:#fff;border-radius:10px;font-weight:700;font-size:12px;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:transparent}

  /* ========== FULLSCREEN AURORA BACKGROUND ========== */
  .aurora-bg{ filter:saturate(1.05) contrast(1.03); pointer-events:none; }
  .aurora-bg.fullscreen{ position:fixed; inset:0; z-index:0; }

  /* CSS fallback (animated gradient) */
  .aurora-bg.css-fallback{
    background:
      radial-gradient(120% 80% at 10% 0%,    #3a29ff33, transparent 60%),
      radial-gradient(120% 80% at 90% 100%,  #ff323233, transparent 60%),
      linear-gradient(90deg, #3A29FF22, #FF94B422 50%, #FF323222);
    animation: auroraShift 10s linear infinite alternate;
  }
  @keyframes auroraShift{
    0%   { filter:hue-rotate(0deg) blur(0.6px) saturate(1.15); }
    100% { filter:hue-rotate(25deg) blur(0.6px) saturate(1.25); }
  }

  @media (max-width:1200px){#tools.tools{grid-template-columns:1fr}}
  @media (max-width:992px){
    body.state-filters .wrap{grid-template-columns:1fr}
    body.state-right .wrap{grid-template-columns:1fr}
    aside.left, aside.right{order:2} main{order:1}
  }
</style>
</head>
<body class="state-main">

  <!-- FULLSCREEN AURORA LAYER -->
  <div id="auroraCanvas" class="aurora-bg fullscreen"></div>

  <!-- AI Search Landing -->
  <div id="aiLanding">
    <img src="logos/clario.png" alt="Clario" style="height:22px;margin-bottom:6px">
    <h2 style="margin:0;color:#102a43;font-size:18px">Describe the legal-tech you’re looking for</h2>
    <div class="sub">e.g. “AI contract automation for in-house teams in Australia”</div>

    <textarea id="aiQuery" rows="3" placeholder="Type your search…"
      style="width:min(620px,86vw);padding:12px;border-radius:12px;border:1px solid #d0e2ea;font-size:14px;resize:none;background:#fff;"></textarea>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="aiSearchBtn" class="btn primary">Search</button>
      <button id="pingBtn" class="btn">Ping API</button>
      <button id="overlayLoadBtn" class="btn">Load CSV</button>
    </div>
    <div id="aiStatus" class="sub" style="min-height:18px"></div>
  </div>

  <!-- Top bar -->
  <header>
    <div class="topbar">
      <div class="brand">
        <img src="logos/clario.png" alt="Clario" class="brand-logo">
        <h1>Legal-Tech Explorer</h1>
      </div>
      <span class="spacer"></span>
      <button id="filtersBtn" class="btn">Filters</button>
      <button id="loadBtn" class="btn">Load CSV</button>
      <input id="fileInput" type="file" accept=".csv" style="display:none" />
    </div>
  </header>

  <div class="wrap">
    <!-- Left: Filters -->
    <aside class="left">
      <div class="toolbar">
        <div class="col-title">Filters</div>
        <button class="btn" id="closeFilters">Close</button>
      </div>
      <div class="box filters">
        <div class="sub" style="margin-bottom:6px">Quick & minimal facets</div>
      </div>
    </aside>

    <!-- Middle: Results -->
    <main>
      <div class="toolbar">
        <div class="col-title">Results</div>
        <div style="display:flex;align-items:center;gap:12px">
          <span class="sub" id="count"></span>
        </div>
      </div>
      <div class="box alt">
        <div id="tools" class="tools"></div>
      </div>
    </main>

    <!-- Right: Details / Compare -->
    <aside class="right">
      <div class="toolbar" style="gap:8px">
        <div style="display:flex;flex-direction:column;gap:6px">
          <div class="col-title" id="rightTitle">Panel</div>
          <div class="tabs">
            <button id="tabDetails" class="tab active" type="button">Details</button>
            <button id="tabCompare" class="tab" type="button">Compare <span id="compareCount">(0)</span></button>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="expandRight">Expand</button>
          <button class="btn" id="closeRight">Close</button>
        </div>
      </div>

      <div class="box" id="rightBody"><div id="details">Select a tool to see full info.</div></div>

      <div class="box" id="compareBox" style="display:none">
        <div class="col-title" style="margin-bottom:8px">Comparison (up to 5)</div>
        <div id="compareList" class="filter-row"></div>
        <div style="height:8px"></div>
        <div style="max-height:360px;overflow:auto">
          <table class="compare" id="compareTable" style="width:100%;border-collapse:separate;border-spacing:0 8px;font-size:12px"></table>
        </div>
      </div>
    </aside>
  </div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- your existing app code -->
  <script>
  // Polyfill CSS.escape
  if (typeof CSS === 'undefined' || typeof CSS.escape !== 'function') {
    (function(){ var cssEscape = function(value){ return String(value).replace(/[^a-zA-Z0-9_\u00A0-\u10FFFF-]/g,'\\\\$&'); };
      window.CSS = window.CSS || {}; CSS.escape = CSS.escape || cssEscape; })();
  }

  /* ===== Schema / Data / Helpers ===== */
  var SCHEMA = [
    { key: 'Vendor Name', group: 'Vendor Identification', type: 'text' },
    { key: 'Vendor Overview', group: 'Vendor Identification', type: 'text' },
    { key: 'HQ', group: 'Vendor Identification', type: 'single' },
    { key: 'Office Locations', group: 'Vendor Identification', type: 'text' },
    { key: 'Regions Served', group: 'Vendor Identification', type: 'multi', values: ['Australia','New Zealand','Asia-Pacific (APAC)','North America (US & Canada)','Europe (UK & EU)','United Kingdom','Middle East','Africa','Latin America','Unknown'] },
    { key: 'Year Founded', group: 'Vendor Identification', type: 'number-range' },

    { key: 'Product Name', group: 'Product Identification', type: 'text' },
    { key: 'Product Description', group: 'Product Identification', type: 'text' },
    { key: 'Languages supported', group: 'Product Identification', type: 'single', values: ['English only','English + Limited Other Languages','Multilingual (supports major global languages)','Unknown / To Verify'] },

    { key: 'Legal Functionality – Main Category', group: 'Legal Functionality & Use Case', type: 'single', values: ['Contracting & Document Automation','Matter, Workflow & Intake Management','Legal Operations & Analytics','Outside Counsel & Spend Management','Compliance, Risk & Governance','Corporate Governance & Entity Management','Litigation, Disputes & Investigations','Intellectual Property, Technology & Data','Employment & HR Legal Support','Cross-Border, Transactions & Deal Management','Knowledge, Search & Precedent Management','AI Legal Assistants & Productivity Tools','Business Partnering & Self-Service Tools','Integration & Platform Infrastructure','Legal Research & Insights.'] },
    { key: 'Legal Functionality – Sub-Category', group: 'Legal Functionality & Use Case', type: 'single' },
    { key: 'Main Problem Solved', group: 'Legal Functionality & Use Case', type: 'text' },

    { key: 'Primary User Segment', group: 'Audience, Fit & Accessibility', type: 'multi', values: ['Corporate legal','Private practice','Alternative Legal Service Providers (ALSPs)','Legal Operations Professionals','Contract Management Teams / Procurement','Compliance & Risk Teams','Litigation / Disputes Teams','Intellectual Property Teams.'] },
    { key: 'Industry Focus', group: 'Audience, Fit & Accessibility', type: 'single', values: ['Corporate','Government / Public Sector','Financial Services','Healthcare / Life Sciences','Education / Research','Energy / Resources','Professional Services','Other / Not Specified'] },

    { key: 'AI Maturity Stage', group: 'AI Capabilities & Innovation', type: 'single', values: ['Experimental / early stage','Quick win','Advanced','Enterprise-grade'] },
    { key: 'AI Powered', group: 'AI Capabilities & Innovation', type: 'single', values: ['Yes','No'] },
    { key: 'AI Platform', group: 'AI Capabilities & Innovation', type: 'multi', values: ['Large Language Model (LLM) Platforms','Predictive / Machine Learning (ML) Platforms','Natural Language Processing (NLP) / Text Analytics','Computer Vision & Document Recognition','Recommendation & Decision Support Systems','Conversational / Copilot Layer','AI Integration / Orchestration Layer','Domain-Specific or Proprietary AI Engines.'] },
    { key: 'Deployment Model', group: 'AI Capabilities & Innovation', type: 'single', values: ['Cloud (SaaS)','Private Cloud','On-Premises','Hybrid','Desktop / Local Application.'] },
    { key: 'Hosting Location / Data Residence', group: 'AI Capabilities & Innovation', type: 'single', values: ['Australia','Asia-Pacific (ex-AU)','United States','Europe / UK','Multi-Region / Distributed Cloud','Customer-Hosted / Private Cloud','Unknown / To Verify'] },
    { key: 'Hosting Provider', group: 'AI Capabilities & Innovation', type: 'single', values: ['AWS','Azure','Google Cloud','Other'] },

    { key: 'ISO Certifications', group: 'Security, Privacy & Trust', type: 'multi', values: ['ISO 27001','ISO 27017','ISO 27018','ISO 27701','ISO 22301','ISO 9001','ISO 20000'] },
    { key: 'Security & Compliance Certifications', group: 'Security, Privacy & Trust', type: 'multi', values: ['SOC 1 (Type I or II)','SOC 2 (Type I or II)','SOC 3','GDPR Compliance (EU)','CCPA Compliance (US)','HIPAA Compliance (US)','FedRAMP, Authorization (US)','IRAP Assessment (AU)','CSA STAR Certification','Cyber Essentials / Plus (UK).'] },

    { key: 'Pricing Model', group: 'Commercials & Procurement', type: 'single', values: ['Subscription (SaaS)','Usage-Based / Consumption','Per Seat / License','Tiered / Plan-Based','Enterprise Custom Quote','Freemium / Free Trial','One-Time Purchase / Perpetual License.'] },
    { key: 'Approx. Price Range (AUD)', group: 'Commercials & Procurement', type: 'single', values: ['<$10K','$10K–$50K','$51K-$100K','$101K+'] },
    { key: 'Demo / Proof of Concept Available', group: 'Commercials & Procurement', type: 'single', values: ['Yes','No','Unknown'] },
    { key: 'Adoption Level', group: 'Commercials & Procurement', type: 'single', values: ['Emerging / New Entrant','Growing Adoption','Mainstream / Proven','Market Leader / Standard','Unknown / To Verify'] },
    { key: 'Ease of Purchase', group: 'Commercials & Procurement', type: 'single', values: ['Very Easy','Easy','Moderate','Complex'] },

    { key: 'Customer Reviews', group: 'Customer Reviews', type: 'text' },
    { key: 'Customer Feedback Rating', group: 'Customer Reviews', type: 'number-range' },

    { key: 'Vendor Contact Details', group: 'Vendor Identification', type: 'text' },
    { key: 'Vendor Website', group: 'Vendor Identification', type: 'text' }
  ];

  var DATA = [{
    "__id":"actionstep-actionstep-https-www-actionstep-com-0",
    "__display_name":"Actionstep — Actionstep",
    "Vendor Name":"Actionstep",
    "Vendor Overview":"Actionstep is a modern, adaptable law firm management platform designed to streamline legal operations and improve client service.",
    "HQ":"New Zealand",
    "Regions Served":"Asia-Pacific (APAC); North America (US & Canada); Europe (UK & EU); Latin America",
    "Year Founded":"2004",
    "Product Name":"Actionstep",
    "Product Description":"Comprehensive practice management with workflows, matter management, document automation, and billing.",
    "Languages supported":"English only",
    "Legal Functionality – Main Category":"Matter, Workflow & Intake Management",
    "Legal Functionality – Sub-Category":"Workflow Automation",
    "Primary User Segment":"Corporate legal; Legal Operations Professionals",
    "AI Maturity Stage":"Enterprise-grade",
    "AI Powered":"Yes",
    "AI Platform":"Large Language Model (LLM) Platforms; AI Integration / Orchestration Layer",
    "Deployment Model":"Cloud (SaaS)",
    "Hosting Location / Data Residence":"Multi-Region / Distributed Cloud",
    "Hosting Provider":"AWS",
    "ISO Certifications":"ISO 27001",
    "Security & Compliance Certifications":"SOC 2 (Type I or II); GDPR Compliance (EU)",
    "Pricing Model":"Subscription (SaaS)",
    "Approx. Price Range (AUD)":"$10K–$50K",
    "Demo / Proof of Concept Available":"Yes",
    "Adoption Level":"Mainstream / Proven",
    "Ease of Purchase":"Moderate",
    "Customer Reviews":"Well regarded by midsize firms",
    "Customer Feedback Rating":"4.3",
    "Vendor Contact Details":"https://www.actionstep.com/contact/",
    "Vendor Website":"https://www.actionstep.com/"
  }];

  function esc(s){ return (s||'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
  function splitMulti(v){ if(!v) return []; return String(v).split(/[;,|\/\n]+/).map(x=>x.trim()).filter(Boolean); }
  function vendorSlug(name){ return String(name||'').toLowerCase().replace(/[^a-z0-9]/g,''); }
  function vendorNoSpace(name){ return String(name||'').replace(/\s+/g,''); }
  function logoCandidates(name){ var a=[], raw=vendorNoSpace(name), slug=vendorSlug(name); ['png','jpg','jpeg','webp'].forEach(ext=>{ a.push('logos/'+raw+'.'+ext); a.push('logos/'+slug+'.'+ext); }); return a; }
  function makeLogoEl(name){
    var img=document.createElement('img'); img.className='logo';
    var tries=logoCandidates(name); if(!tries.length){ return initialsBadge(name); }
    img.dataset.tries=JSON.stringify(tries); img.dataset.try='0'; img.alt=name+' logo'; img.src=tries[0];
    img.onerror=function(){ var idx=+img.dataset.try+1, arr=JSON.parse(img.dataset.tries); if(idx<arr.length){ img.dataset.try=String(idx); img.src=arr[idx]; } else { var badge=initialsBadge(name); img.replaceWith(badge); } };
    return img;
  }
  function initialsBadge(name){ var d=document.createElement('div'); d.className='logo-badge'; var t=(name||'').trim(); var parts=t.split(/\s+/); var ini=''; if(parts.length>1){ ini=parts[0][0]+parts[parts.length-1][0]; } else { ini=t.slice(0,2); } d.textContent=ini.toUpperCase(); return d; }

  var filtersBox = document.querySelector('.filters');
  var toolsEl = document.getElementById('tools');
  var detailsEl = document.getElementById('details');
  var countEl = document.getElementById('count');
  var rightTitle = document.getElementById('rightTitle');
  var rightBody = document.getElementById('rightBody');
  var compareBox = document.getElementById('compareBox');

  var CONTROLS = new Map();
  var RIGHT_MODE = null;
  var compare = [];

  var ALLOWED_FILTER_KEYS = [
    'Regions Served','Legal Functionality – Main Category','Primary User Segment',
    'AI Maturity Stage','Ease of Purchase','Adoption Level','Deployment Model','Pricing Model'
  ];

  function buildFilters(){
    CONTROLS = new Map();
    filtersBox.innerHTML = '<div class="sub" style="margin-bottom:6px">Quick & minimal facets</div>';

    var quick=document.createElement('div');
    quick.className='filter-field';
    quick.innerHTML='<label>Quick Search</label><input id="q" type="search" placeholder="Search tool, vendor, description…">';
    filtersBox.appendChild(quick);
    window.q=document.getElementById('q');

    function groupContainer(title){
      var d=document.createElement('details'); d.className='group'; d.open=true;
      d.innerHTML='<summary>'+esc(title)+'</summary>';
      filtersBox.appendChild(d); return d;
    }
    function uniqueValues(key){
      var cfg=SCHEMA.find(s=>s.key===key);
      if(cfg && cfg.values) return cfg.values;
      var vals={};
      DATA.forEach(function(r){
        var arr=splitMulti(r[key]);
        if(arr.length){ arr.forEach(v=>vals[v]=1); }
        else if(r[key]){ vals[String(r[key])]=1; }
      });
      return Object.keys(vals).sort();
    }
    function addSingleSelect(parent, key, options){
      var wrap=document.createElement('div'); wrap.className='filter-field';
      var html='<label>'+esc(key)+'</label><select data-key="'+esc(key)+'"><option value="">Any</option>';
      options.forEach(v=>{ html+='<option>'+esc(v)+'</option>'; });
      html+='</select>'; wrap.innerHTML=html; parent.appendChild(wrap);
      var sel=wrap.querySelector('select');
      CONTROLS.set(key,{ type:'single', get:function(){ return sel.value; }, _el: sel });
    }
    function addMultiChips(parent, key, options){
      var wrap=document.createElement('div'); wrap.className='filter-field';
      wrap.innerHTML='<label>'+esc(key)+'</label><div class="filter-row" data-key="'+esc(key)+'"></div>';
      parent.appendChild(wrap);
      var row=wrap.querySelector('.filter-row');
      options.forEach(function(v){
        var lab=document.createElement('label'); lab.className='chip';
        lab.innerHTML='<input type="checkbox" value="'+esc(v)+'"> <span>'+esc(v)+'</span>';
        row.appendChild(lab);
      });
      var holder=document.createElement('div'); holder.style.display='none'; holder.setAttribute('data-key', key);
      options.forEach(function(v){ var l=document.createElement('label'); l.innerHTML='<input type="checkbox" value="'+esc(v)+'">'; holder.appendChild(l); });
      document.body.appendChild(holder);
      CONTROLS.set(key,{ type:'multi', get:function(){ return Array.prototype.map.call(row.querySelectorAll('input:checked'), c=>c.value); }, _el: holder, _row: row });
    }

    var sec=groupContainer('Filters');

    ALLOWED_FILTER_KEYS.forEach(function(key){
      var cfg=SCHEMA.find(s=>s.key===key); if(!cfg) return;
      var opts=uniqueValues(key);
      if(cfg.type==='single') addSingleSelect(sec,key,opts);
      else if(cfg.type==='multi') addMultiChips(sec,key,opts);
    });

    var hiddenKeys = SCHEMA.map(s=>s.key).filter(k => ALLOWED_FILTER_KEYS.indexOf(k)===-1);
    hiddenKeys.forEach(function(key){
      var cfg=SCHEMA.find(s=>s.key===key); if(!cfg) return;
      if(cfg.type==='single'){
        var sel=document.createElement('select'); sel.setAttribute('data-key', key); sel.style.display='none';
        var values = uniqueValues(key);
        sel.innerHTML = '<option value=""></option>' + values.map(v=>'<option>'+esc(v)+'</option>').join('');
        document.body.appendChild(sel);
        CONTROLS.set(key,{ type:'single', get:function(){ return sel.value; }, _el: sel });
      } else if(cfg.type==='multi'){
        var holder=document.createElement('div'); holder.style.display='none'; holder.setAttribute('data-key', key);
        var values = uniqueValues(key);
        holder.innerHTML = values.map(v=>'<label><input type="checkbox" value="'+esc(v)+'"></label>').join('');
        document.body.appendChild(holder);
        CONTROLS.set(key,{ type:'multi', get:function(){ return Array.prototype.map.call(holder.querySelectorAll('input:checked'), c=>c.value); }, _el: holder });
      } else {
        var inp=document.createElement('input'); inp.type='text'; inp.style.display='none'; inp.setAttribute('data-key', key);
        document.body.appendChild(inp);
        CONTROLS.set(key,{ type:'single', get:function(){ return inp.value; }, _el: inp });
      }
    });

    var optRow=document.createElement('div'); optRow.className='filter-field';
    optRow.innerHTML='<label>Options</label><label style="font-size:12px;color:var(--muted)"><input id="dedupeVendor" type="checkbox" checked> Deduplicate identical rows</label>';
    filtersBox.appendChild(optRow);
  }

  function quickBlob(rec){
    return (rec.__display_name+' '+(rec['Vendor Name']||'')+' '+(rec['Product Name']||'')+' '+(rec['Product Description']||'')+' '+(rec['Vendor Overview']||''));
  }
  function multiMatch(recVal, selected){
    if(!selected || !selected.length) return true;
    var hay=splitMulti(recVal);
    var set={}; hay.forEach(v=>set[v]=1);
    for(var i=0;i<selected.length;i++){ if(set[selected[i]]) return true; }
    return false;
  }
  function matchRecord(rec){
    var t=(window.q && q.value.trim().toLowerCase())||'';
    if(t){ if(quickBlob(rec).toLowerCase().indexOf(t)===-1) return false; }

    for (const [key, ctl] of CONTROLS.entries()){
      var val = ctl.get && ctl.get();
      if(!val || (Array.isArray(val) && !val.length)) continue;

      var schema = SCHEMA.find(s=>s.key===key);
      if(schema && schema.type==='multi'){
        if(!multiMatch(rec[key], Array.isArray(val)?val:[val])) return false;
      } else if(schema && schema.type==='number-range'){
        if(String(rec[key]||'') !== String(val)) return false;
      } else {
        if(String(rec[key]||'') !== String(val)) return false;
      }
    }
    return true;
  }
  function keyByVendorTool(rows){
    var seen={}, out=[]; rows.forEach(function(r){
      var k=(r['Vendor Name']||'')+'|'+(r['Product Name']||'')+'|'+(r['Vendor Website']||'');
      if(!seen[k]){ seen[k]=1; out.push(r); }
    });
    return out;
  }

  function renderList(rows){
    countEl.textContent = rows.length + ' tools';
    toolsEl.innerHTML = '';
    rows.slice(0,200).forEach(function(rec){
      var url = rec['Vendor Website'] || '';
      var chosen = compare.indexOf(rec.__id)!==-1;
      var cats = splitMulti(rec['Legal Functionality – Main Category']).concat(splitMulti(rec['Legal Functionality – Sub-Category']));
      var chips = cats.map(c=>'<span class="chip" style="padding:2px 8px;font-size:11px">'+esc(c)+'</span>').join(' ');
      var card = document.createElement('div'); card.className='tool'; card.dataset.id = rec.__id;

      var head = document.createElement('div'); head.className='tool-head';
      head.appendChild(makeLogoEl(rec['Vendor Name']||rec['Vendor']||''));
      var titleWrap = document.createElement('div');
      titleWrap.innerHTML = '<div class="title">'+esc(rec.__display_name||rec['Product Name']||rec['Vendor Name']||'Unnamed')+'</div>'+
                            '<div class="meta">'+esc(rec['Vendor Name']||'')+' • <span>'+esc(rec['HQ']||'')+'</span> '+(url?('• <a href="'+esc(url)+'" target="_blank" rel="noopener">Open ↗</a>'):'')+'</div>';
      head.appendChild(titleWrap);

      var desc = document.createElement('div'); desc.className='desc'; desc.textContent = rec['Product Description']||'';
      var chipRow = document.createElement('div'); chipRow.className='filter-row'; chipRow.innerHTML = chips;

      var act = document.createElement('div'); act.className='actions';
      var detailsBtn = document.createElement('button'); detailsBtn.className='btn btn-details'; detailsBtn.textContent='Details';
      var cmpBtn = document.createElement('button'); cmpBtn.className='btn btn-compare'; cmpBtn.textContent = chosen? 'Remove from compare':'Add to compare';
      act.appendChild(detailsBtn); act.appendChild(cmpBtn);

      card.appendChild(head); card.appendChild(desc); card.appendChild(chipRow); card.appendChild(act);
      toolsEl.appendChild(card);
    });

    Array.prototype.forEach.call(toolsEl.querySelectorAll('.btn-details'), function(btn){
      btn.addEventListener('click', function(e){
        var id=e.target.closest('.tool').dataset.id;
        var rec=DATA.find(function(r){return r.__id===id;});
        renderDetails(rec); openRight('details'); switchTab('details');
      });
    });
    Array.prototype.forEach.call(toolsEl.querySelectorAll('.btn-compare'), function(btn){
      btn.addEventListener('click', function(e){
        var id=e.target.closest('.tool').dataset.id;
        toggleCompare(id); applyFilters(); openRight('compare'); switchTab('compare');
      });
    });
  }

  function renderDetails(rec){
    var details = document.getElementById('details');
    if(!rec){ details.textContent='No record'; return; }
    rightTitle.textContent = 'Details';
    compareBox.style.display='none';
    rightBody.style.display='block';

    var top=document.createElement('div'); top.style.display='flex'; top.style.gap='10px'; top.style.alignItems='center'; top.style.marginBottom='8px';
    top.appendChild(makeLogoEl(rec['Vendor Name']||''));
    var name=document.createElement('div'); name.innerHTML='<div class="title">'+esc(rec.__display_name||'')+'</div>';
    top.appendChild(name);

    var rows='';
    Object.keys(rec).forEach(function(k){
      if(/^_/.test(k) || /^__/.test(k)) return;
      var v=rec[k]; if(v==null || v==='') return;
      var val=esc(v); if(/^https?:\/\//i.test(String(v))) val='<a href="'+v+'" target="_blank" rel="noopener">'+esc(v)+'</a>';
      rows+='<tr><th style="text-align:left;padding:6px 10px;background:#fff;border:1px solid var(--border)">'+esc(k)+'</th><td style="padding:6px 10px;background:#fff;border:1px solid var(--border)">'+val+'</td></tr>';
    });
    details.innerHTML=''; details.appendChild(top);
    var tbl=document.createElement('table'); tbl.style.width='100%'; tbl.style.borderCollapse='separate'; tbl.style.borderSpacing='0 8px'; tbl.innerHTML=rows; details.appendChild(tbl);
  }

  function renderCompare(){
    rightTitle.textContent='Comparison';
    rightBody.style.display='none'; compareBox.style.display='block';

    var list=document.getElementById('compareList'); var tbl=document.getElementById('compareTable');
    list.innerHTML=''; if(!compare.length){ tbl.innerHTML='<tr><td style="color:var(--muted)">Nothing selected</td></tr>'; updateCompareCount(); return; }
    compare.forEach(function(id){
      var rec=DATA.find(function(r){return r.__id===id;});
      var pill=document.createElement('div'); pill.className='chip';
      var name=document.createElement('span'); name.textContent=' '+(rec.__display_name||''); pill.appendChild(name);
      var x=document.createElement('span'); x.textContent='✕'; x.className='x'; x.style.cursor='pointer'; x.dataset.id=id; pill.appendChild(x);
      list.appendChild(pill);
    });
    Array.prototype.forEach.call(list.querySelectorAll('.x'), function(x){
      x.addEventListener('click', function(e){ var id=e.target.getAttribute('data-id'); var i=compare.indexOf(id); if(i!==-1){ compare.splice(i,1); renderCompare(); } });
    });

    var cols=SCHEMA.map(s=>s.key).slice(0,24);
    var header='<tr><th style="text-align:left;padding:6px 10px;background:#fff;border:1px solid var(--border)">Field</th>'+compare.map(function(id){ var rec=DATA.find(r=>r.__id===id); return '<th style="text-align:left;padding:6px 10px;background:#fff;border:1px solid var(--border)">'+esc(rec.__display_name)+'</th>'; }).join('')+'</tr>';
    var html=header;
    cols.forEach(function(col){
      html+='<tr><th style="text-align:left;padding:6px 10px;background:#fff;border:1px solid var(--border)">'+esc(col)+'</th>';
      compare.forEach(function(id){
        var rec=DATA.find(r=>r.__id===id);
        var val=rec[col]||'';
        if(/^https?:\/\//i.test(String(val))) val='<a href="'+val+'" target="_blank" rel="noopener">Open ↗</a>';
        html+='<td style="padding:6px 10px;background:#fff;border:1px solid var(--border)">'+(val? esc(String(val)).replace(/(https?:\/\/\S+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>'):'')+'</td>';
      });
      html+='</tr>';
    });
    tbl.innerHTML=html;
    updateCompareCount();
  }

  function toggleCompare(id){
    var i=compare.indexOf(id);
    if(i===-1){ if(compare.length>=5) return; compare.push(id); }
    else compare.splice(i,1);
    if(RIGHT_MODE==='compare'){ renderCompare(); } else { updateCompareCount(); }
  }

  function updateCompareCount(){
    var el=document.getElementById('compareCount');
    if(el){ el.textContent='(' + compare.length + ')'; }
  }

  function applyFilters(){
    var rows=DATA.filter(matchRecord);
    var dedupe=document.getElementById('dedupeVendor');
    if(dedupe && dedupe.checked) rows=keyByVendorTool(rows);
    renderList(rows);
    if(RIGHT_MODE==='compare'){ renderCompare(); }
    updateCompareCount();
  }

  function normalizeRows(rows){
    if(!rows.length) return [];
    var out=[]; rows.forEach(function(r,i){
      var vendor=r['Vendor Name']||r['Vendor']||r['Company']||'';
      var tool  =r['Product Name']||r['Tool']||r['Product']||'';
      var url   =r['Vendor Website']||r['Website']||r['URL']||'';
      var id=(vendor||'')+'|'+(tool||'')+'|'+(url||'')+'|'+i;
      var display = tool ? (String(vendor).toLowerCase().indexOf(String(tool).toLowerCase())>-1 ? String(tool) : (tool+' — '+(vendor||''))) : (vendor||'Unnamed Tool');
      var rec=Object.assign({}, r, { __id:id, __display_name:display });
      out.push(rec);
    });
    var uniq={}; var dedup=[];
    out.forEach(function(r){ var k=JSON.stringify(r); if(!uniq[k]){ uniq[k]=1; dedup.push(r);} });
    return dedup;
  }

  function loadCSVFromText(text){
    var parsed=Papa.parse(text,{ header:true, skipEmptyLines:true });
    if(parsed.errors && parsed.errors.length){ alert('CSV parse error: '+parsed.errors[0].message); }
    DATA=normalizeRows(parsed.data);
    buildFilters();
    filtersBox.addEventListener('input', applyFilters);
    applyFilters();
  }

  // Layout state helpers
  function openFilters(){ document.body.classList.remove('state-main','state-right'); document.body.classList.add('state-filters'); }
  function closeFilters(){ document.body.classList.remove('state-filters'); if(RIGHT_MODE) document.body.classList.add('state-right'); else document.body.classList.add('state-main'); }
  function openRight(mode){
    RIGHT_MODE=mode; document.body.classList.remove('state-main','state-filters'); document.body.classList.add('state-right');
    if(mode==='details'){ rightTitle.textContent='Details'; rightBody.style.display='block'; compareBox.style.display='none'; }
    if(mode==='compare'){ renderCompare(); }
  }
  function closeRight(){
    RIGHT_MODE=null; document.body.classList.remove('state-right','state-right-wide');
    document.getElementById('expandRight').textContent='Expand';
    if(document.body.classList.contains('state-filters')){} else { document.body.classList.add('state-main'); }
  }
  function switchTab(mode){
    const tDetails=document.getElementById('tabDetails');
    const tCompare=document.getElementById('tabCompare');
    tDetails.classList.toggle('active', mode==='details');
    tCompare.classList.toggle('active', mode==='compare');
    openRight(mode);
  }

  // Header buttons
  document.getElementById('filtersBtn').onclick=openFilters;
  document.getElementById('closeFilters').onclick=closeFilters;
  document.getElementById('closeRight').onclick=closeRight;

  document.getElementById('loadBtn').onclick=function(){ document.getElementById('fileInput').click(); };
  document.getElementById('fileInput').addEventListener('change', function(e){
    var f=e.target.files && e.target.files[0]; if(!f) return;
    var r=new FileReader(); r.onload=function(){ loadCSVFromText(r.result); }; r.readAsText(f);
  });

  document.getElementById('tabDetails').addEventListener('click', ()=>switchTab('details'));
  document.getElementById('tabCompare').addEventListener('click', ()=>switchTab('compare'));
  document.getElementById('expandRight').addEventListener('click', ()=>{
    const btn = document.getElementById('expandRight');
    const wide = document.body.classList.toggle('state-right-wide');
    btn.textContent = wide ? 'Collapse' : 'Expand';
  });

  // AI integration
  const aiLanding=document.getElementById('aiLanding');
  const aiBtn=document.getElementById('aiSearchBtn');
  const aiQuery=document.getElementById('aiQuery');
  const aiStatus=document.getElementById('aiStatus');

  async function runAISearch(){
    const q = aiQuery.value.trim();
    if(!q){ aiStatus.textContent="Please type what you need."; return; }
    aiStatus.textContent="Thinking…";

    try{
      const res = await fetch("http://127.0.0.1:8000/query", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ query:q })
      });

      if(!res.ok){
        const text = await res.text().catch(()=>"<no body>");
        console.error("AI /query error", res.status, text);
        aiStatus.textContent = `Server error ${res.status}: ${text}`;
        return;
      }

      const filters = await res.json();

      if(!CONTROLS || CONTROLS.size===0){
        buildFilters();
        document.querySelector('.filters').addEventListener('input', applyFilters);
      }

      for(const [key,val] of Object.entries(filters)){ setFilterValue(key,val); }

      aiStatus.textContent="Applying…";
      aiLanding.style.display="none";
      openFilters();
      applyFilters();

    }catch(err){
      console.error("Network/Fetch failed:", err);
      aiStatus.textContent = `Couldn’t reach the AI server: ${err?.message||err}`;
    }
  }

  function setFilterValue(key, value){
    const ctl = CONTROLS.get(key);
    if(!ctl || value==null || value==="") return;

    if(ctl.type === 'single'){
      const sel = document.querySelector(`select[data-key="${CSS.escape(key)}"]`) || ctl._el;
      if(!sel) return;
      if(sel.tagName === 'SELECT'){
        let picked=false;
        const want=String(value).trim().toLowerCase();
        for(const opt of sel.options){
          if(opt.text.trim().toLowerCase()===want){ sel.value=opt.text; picked=true; break; }
        }
        if(!picked){ sel.value=''; }
      } else if(sel.tagName === 'INPUT'){
        sel.value = String(value);
      }
    } else if(ctl.type === 'multi'){
      const holder = ctl._el;
      const row    = ctl._row;
      const want = Array.isArray(value) ? value : [value];
      const needles = want.map(w => String(w).trim().toLowerCase());

      if(holder){
        holder.querySelectorAll('input[type="checkbox"]').forEach(c=>{
          if(needles.includes(c.value.trim().toLowerCase())) c.checked = true;
        });
      }
      if(row){
        row.querySelectorAll('input[type="checkbox"]').forEach(c=>{
          if(needles.includes(c.value.trim().toLowerCase())) c.checked = true;
        });
      }
    }
  }

  aiBtn?.addEventListener('click', runAISearch);
  aiQuery?.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); runAISearch(); }});
  document.getElementById('overlayLoadBtn')?.addEventListener('click', () => {
    document.getElementById('fileInput').click();
  });
  document.getElementById('pingBtn').addEventListener('click', async ()=>{
    aiStatus.textContent = "Pinging /health…";
    try{
      const r = await fetch("http://127.0.0.1:8000/health");
      const t = await r.text();
      aiStatus.textContent = `Health ${r.status}: ${t}`;
    }catch(e){
      aiStatus.textContent = `Health check failed: ${e.message}`;
    }
  });

  // Init
  buildFilters();
  filtersBox.addEventListener('input', applyFilters);
  applyFilters();
  </script>

  <!-- AURORA SHADER: fullscreen WebGL with CSS fallback (Triangle-free) -->
  <script type="module">
    import * as OGL from "https://esm.sh/ogl@1.0.11";
    const { Renderer, Program, Mesh, Geometry, Color } = OGL;

    function mountAurora(){
      const host = document.getElementById('auroraCanvas');
      if(!host){ return; }

      let renderer;
      try{
        renderer = new Renderer({ alpha:true, premultipliedAlpha:true, antialias:true, dpr: devicePixelRatio || 1 });
      }catch(e){
        console.warn("[Aurora] Renderer init failed, applying CSS fallback:", e);
        host.classList.add("css-fallback");
        return;
      }

      const gl = renderer.gl;
      if(!gl){ host.classList.add("css-fallback"); return; }

      const isWebGL2 = (gl instanceof WebGL2RenderingContext);

      const VERT = isWebGL2 ? `#version 300 es
        in vec2 position; void main(){ gl_Position = vec4(position, 0.0, 1.0); }`
      : `attribute vec2 position; void main(){ gl_Position = vec4(position, 0.0, 1.0); }`;

      const FRAG = isWebGL2 ? `#version 300 es
        precision highp float;
        uniform float uTime,uAmplitude,uBlend; uniform vec3 uColorStops[3]; uniform vec2 uResolution;
        out vec4 fragColor;
        void main(){
          vec2 uv = gl_FragCoord.xy / uResolution;
          float t = uTime*0.25;
          float y = sin(uv.x*8.0 + t) * 0.25 * uAmplitude;
          float d = smoothstep(uv.y - y - 0.05, uv.y - y + 0.05, 0.5);
          vec3 c = mix(uColorStops[0], mix(uColorStops[1], uColorStops[2], uv.x), uv.x);
          float a = clamp(0.45 + d*uBlend, 0.0, 1.0);
          fragColor = vec4(0.10*c + c*d, a);
        }`
      : `
        precision highp float;
        uniform float uTime,uAmplitude,uBlend; uniform vec3 uColorStops[3]; uniform vec2 uResolution;
        void main(){
          vec2 uv = gl_FragCoord.xy / uResolution;
          float t = uTime*0.25;
          float y = sin(uv.x*8.0 + t) * 0.25 * uAmplitude;
          float d = smoothstep(uv.y - y - 0.05, uv.y - y + 0.05, 0.5);
          vec3 c = mix(uColorStops[0], mix(uColorStops[1], uColorStops[2], uv.x), uv.x);
          float a = clamp(0.45 + d*uBlend, 0.0, 1.0);
          gl_FragColor = vec4(0.10*c + c*d, a);
        }`;

      gl.clearColor(0,0,0,0);
      gl.enable(gl.BLEND);
      gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);

      gl.canvas.style.width = "100%";
      gl.canvas.style.height = "100%";
      gl.canvas.style.display = "block";
      host.appendChild(gl.canvas);

      const geometry = new Geometry(gl, {
        position: { size: 2, data: new Float32Array([-1,-1, 3,-1, -1,3]) }
      });

      const config = {
        colorStops: ["#3A29FF", "#FF94B4", "#FF3232"],
        amplitude: 1.4,
        blend: 0.9,
        speed: 0.7
      };

      const stops = config.colorStops.map(hex => {
        const c = new Color(hex); return [c.r, c.g, c.b];
      });

      const program = new Program(gl, {
        vertex: VERT, fragment: FRAG,
        uniforms: {
          uTime:       { value: 0 },
          uAmplitude:  { value: config.amplitude },
          uColorStops: { value: stops },
          uResolution: { value: [host.clientWidth, host.clientHeight] },
          uBlend:      { value: config.blend }
        }
      });

      const mesh = new Mesh(gl, { geometry, program });

      function resize(){
        const w = Math.max(1, host.clientWidth || window.innerWidth);
        const h = Math.max(1, host.clientHeight || window.innerHeight);
        renderer.setSize(w, h, (window.devicePixelRatio||1));
        program.uniforms.uResolution.value = [w, h];
      }

      const roHost = new ResizeObserver(resize);
      roHost.observe(host);
      window.addEventListener('resize', resize);
      resize();

      let raf = 0;
      const t0 = performance.now();
      function frame(now){
        raf = requestAnimationFrame(frame);
        program.uniforms.uTime.value = (now - t0) * 0.001 * (config.speed ?? 1.0);
        renderer.render({ scene: mesh });
      }
      raf = requestAnimationFrame(frame);
    }

    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", mountAurora);
    } else {
      mountAurora();
    }
  </script>
</body>
</html>