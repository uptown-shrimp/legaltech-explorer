<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Legal-Tech Explorer — 50-Tool Demo (CSV Loader)</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  :root{
    --bg:#0b1220; --panel:#0e1526; --card:#0f1a33; --border:rgba(255,255,255,.12);
    --muted:#97a3b6; --text:#e8f0ff; --accent:#7aa2f7;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0a0f1c);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;padding:10px 14px;background:rgba(5,8,14,.7);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  header h1{margin:0;font-size:16px;font-weight:700}
  .sub{color:var(--muted);font-size:12px}
  .wrap{display:grid;grid-template-columns:320px 1fr 380px;gap:12px;padding:12px;min-height:calc(100vh - 52px)}
  aside.left,aside.right{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:12px;min-height:0}
  main{min-height:0;display:flex;flex-direction:column;gap:12px}
  .box{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer}
  .btn:hover{border-color:rgba(255,255,255,.24)}
  input[type="search"], textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0b1428;color:var(--text)}
  select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0b1428;color:var(--text)}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:999px;cursor:pointer}
  .chip input{accent-color:var(--accent)}
  .tools{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  .tool{border:1px solid var(--border);border-radius:12px;padding:10px;background:#0b162e;display:flex;flex-direction:column;gap:6px}
  .title{font-weight:700;font-size:14px}
  .meta{color:var(--muted);font-size:12px}
  .desc{color:#dfe7ff;font-size:12px}
  .actions{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:6px}
  .stars{display:inline-flex;gap:2px;cursor:pointer;font-size:14px}
  .star{opacity:.6}.star.on{opacity:1}
  .charts canvas{width:100%;height:240px}
  .compare-list{display:flex;gap:8px;flex-wrap:wrap;min-height:36px}
  .pill{background:rgba(255,255,255,.08);border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:flex;align-items:center;gap:8px;font-size:12px}
  .pill .x{cursor:pointer;opacity:.7}
  table.compare{width:100%;border-collapse:collapse;font-size:12px}
  table.compare th,table.compare td{border:1px solid var(--border);padding:6px;vertical-align:top}
  table.compare th{text-align:left;width:180px;background:#0b1428}
  a[href^="http"]{color:#a7c0ff;text-decoration:none} a[href^="http"]:hover{text-decoration:underline}
</style>
</head>
<body>
  <header>
    <h1>Legal-Tech Explorer</h1>
    <div class="sub">Load your CSV → filter, chart, compare (all client-side)</div>
    <button id="loadBtn" class="btn">Load CSV</button>
    <input id="fileInput" type="file" accept=".csv" style="display:none" />
    <button id="pasteBtn" class="btn" title="Paste CSV text">Paste CSV</button>
  </header>

  <div class="wrap">
    <aside class="left">
      <div class="box">
        <div class="row" style="gap:6px;align-items:flex-start">
          <input id="q" type="search" placeholder="Search tool, vendor, description…" />
        </div>
        <div class="row" style="margin-top:8px">
          <select id="vendorSel"><option value="">All vendors</option></select>
        </div>
        <div class="row" style="margin-top:8px">
          <select id="regionSel"><option value="">All regions</option></select>
        </div>
        <div style="margin-top:8px">
          <div style="margin-bottom:6px;font-size:12px;color:var(--muted)">Categories</div>
          <div id="catRow" class="row" style="max-height:128px;overflow:auto"></div>
        </div>
        <div class="row" style="margin-top:8px;font-size:12px;color:var(--muted)">
          <label><input id="dedupeVendor" type="checkbox" checked /> Deduplicate identical rows</label>
        </div>
      </div>

      <div class="box charts">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:700">Charts</div>
          <div class="sub" id="count"></div>
        </div>
        <canvas id="chartCategory"></canvas>
        <div style="height:12px"></div>
        <canvas id="chartVendor"></canvas>
      </div>
    </aside>

    <main>
      <div class="box">
        <div id="tools" class="tools"></div>
      </div>
    </main>

    <aside class="right">
      <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Details</h3>
          <button id="clearDetails" class="btn" style="font-size:12px">Clear</button>
        </div>
        <div id="details">Load a CSV, then click a tool card to see full info.</div>
      </div>
      <div class="box">
        <h3 style="margin:0 0 8px">Comparison (up to 5)</h3>
        <div id="compareList" class="compare-list"></div>
        <div style="height:8px"></div>
        <div style="max-height:320px;overflow:auto">
          <table class="compare" id="compareTable"></table>
        </div>
      </div>
    </aside>
  </div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ---------- Helpers ---------- */
const S = {
  vendor: [/vendor/i, /company/i, /provider/i, /firm/i, /org/i],
  tool:   [/tool/i, /product/i, /solution/i, /name$/i, /title$/i],
  url:    [/url/i, /website/i, /link/i],
  desc:   [/desc/i, /overview/i, /summary/i, /bio/i, /blurb/i],
  cat:    [/category/i, /categories/i, /type$/i, /segment/i],
  tags:   [/tag/i, /labels/i, /keywords/i, /features/i],
  region: [/region/i, /country/i, /^hq$/i, /location/i]
};

function normKey(s){ return String(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_'); }
function splitMulti(v){ if(!v) return []; return String(v).split(/[;,|/]+/).map(x=>x.trim()).filter(Boolean); }
function makeId(vendor, tool, url, idx){ return (vendor||'')+'|'+(tool||'')+'|'+(url||'')+'|'+idx; }
function esc(s){ return (s??'').toString().replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

/* ---------- State ---------- */
let DATA = [];       // normalized records
let VENDORS = [];    // unique vendors
let CATEGORIES = []; // unique categories
let REGIONS = [];    // unique regions
let COMP_FIELDS = []; // chosen compare fields

/* ---------- UI refs ---------- */
const vendorSel = document.getElementById('vendorSel');
const regionSel = document.getElementById('regionSel');
const catRow = document.getElementById('catRow');
const q = document.getElementById('q');
const dedupeVendor = document.getElementById('dedupeVendor');
const toolsEl = document.getElementById('tools');
const detailsEl = document.getElementById('details');
const countEl = document.getElementById('count');

/* ---------- CSV ingest ---------- */
function inferColumn(headers, patterns){
  const keys = headers.map(h=>normKey(h));
  for(const [i,h] of headers.entries()){
    for(const pat of patterns){ if(pat.test(h) || pat.test(keys[i])) return i; }
  }
  return -1;
}

function normalizeRows(rows){
  if(!rows.length) return [];

  const headers = Object.keys(rows[0]);
  const idx = {
    vendor: inferColumn(headers, S.vendor),
    tool:   inferColumn(headers, S.tool),
    url:    inferColumn(headers, S.url),
    desc:   inferColumn(headers, S.desc),
    cat:    inferColumn(headers, S.cat),
    tags:   inferColumn(headers, S.tags),
    region: inferColumn(headers, S.region),
  };

  const normalized = rows.map((r, i)=>{
    const arr = headers.map(h => r[h]);
    const vendor = idx.vendor>=0 ? arr[idx.vendor] : '';
    const tool   = idx.tool>=0   ? arr[idx.tool]   : '';
    const url    = idx.url>=0    ? arr[idx.url]    : '';
    const desc   = idx.desc>=0   ? arr[idx.desc]   : '';
    const catRaw = idx.cat>=0    ? arr[idx.cat]    : '';
    const tagRaw = idx.tags>=0   ? arr[idx.tags]   : '';
    const region = idx.region>=0 ? arr[idx.region] : '';

    const display = tool ? (String(vendor).toLowerCase().includes(String(tool).toLowerCase()) ? String(tool) : `${tool} — ${vendor||''}`) :
                           (vendor || 'Unnamed Tool');

    const rec = {
      __id: makeId(vendor, tool, url, i),
      __display_name: display,
      _vendor: String(vendor||''),
      _tool: String(tool||''),
      _url: String(url||''),
      _desc: String(desc||''),
      _category_raw: String(catRaw||''),
      _tags_raw: String(tagRaw||''),
      _region: String(region||''),
      _categories: splitMulti(catRaw) || splitMulti(tagRaw),
    };
    // keep originals (for Details/Compare) with original keys
    headers.forEach(h => { rec[h] = r[h]; });
    return rec;
  });

  // Deduplicate exactly identical rows
  const deduped = Array.from(new Map(normalized.map(r=>[JSON.stringify(r), r])).values());

  return { records: deduped, headers, idx };
}

function updateFacets(records){
  VENDORS   = Array.from(new Set(records.map(r => r._vendor).filter(Boolean))).sort();
  CATEGORIES= Array.from(new Set(records.flatMap(r => r._categories && r._categories.length ? r._categories : ['—']))).sort();
  REGIONS   = Array.from(new Set(records.map(r => r._region).filter(Boolean))).sort();

  // populate selects
  vendorSel.innerHTML = '<option value="">All vendors</option>' + VENDORS.map(v=>`<option>${esc(v)}</option>`).join('');
  regionSel.innerHTML = '<option value="">All regions</option>' + REGIONS.map(r=>`<option>${esc(r)}</option>`).join('');

  // chips
  catRow.innerHTML = '';
  CATEGORIES.forEach(c=>{
    const lab = document.createElement('label'); lab.className = 'chip';
    lab.innerHTML = `<input type="checkbox" value="${esc(c)}"> <span>${esc(c)}</span>`;
    catRow.appendChild(lab);
  });

  // Compare fields: prefer a sensible subset
  const preferred = ["Vendor Name","Product Name","Tool","Website","URL","Link","Vendor Overview","Product Description","Description","Category","Categories","Tags","Region","Regions Served","Pricing","Price","Cost"];
  const headers = Object.keys(records[0] || {});
  const chosen = [];
  preferred.forEach(p => { if (headers.includes(p) && chosen.length < 18) chosen.push(p); });
  headers.forEach(h => { if (!chosen.includes(h) && !/^_/.test(h) && !/^__/.test(h) && chosen.length < 18) chosen.push(h); });
  COMP_FIELDS = chosen;
}

function loadCSVFromText(csvText){
  const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true });
  if(parsed.errors?.length){
    alert("CSV parse errors (showing first): " + parsed.errors[0].message);
  }
  const { records } = normalizeRows(parsed.data);
  DATA = records;
  updateFacets(DATA);
  applyFilters();
}

/* ---------- Filters & rendering ---------- */
function getRating(id){ const v = localStorage.getItem('rate:'+id); return v ? parseInt(v,10) : 0; }
function setRating(id,v){ localStorage.setItem('rate:'+id, String(v)); }

let compare = [];
function toggleCompare(id){
  const i = compare.indexOf(id);
  if(i === -1){ if(compare.length>=5) return; compare.push(id); }
  else compare.splice(i,1);
  renderCompare();
}

function matchRecord(rec, text, vendor, region, cats){
  if (vendor && (rec._vendor||'') !== vendor) return false;
  if (region && (rec._region||'') !== region) return false;
  if (cats.length){
    const set = new Set(rec._categories || []);
    let ok = false; for(const c of cats) if(set.has(c)) { ok = true; break; }
    if (!ok) return false;
  }
  if (text){
    const t = text.toLowerCase();
    const blob = (rec.__display_name+' '+(rec._desc||'')+' '+(rec._vendor||'')+' '+(rec._tool||'')+' '+(rec._category_raw||'')+' '+(rec._tags_raw||'')).toLowerCase();
    if (!blob.includes(t)) return false;
  }
  return true;
}

function currentFilters(){
  const text = q.value.trim();
  const vendor = vendorSel.value;
  const region = regionSel.value;
  const cats = [...catRow.querySelectorAll('input:checked')].map(c=>c.value);
  return { text, vendor, region, cats };
}

function keyByVendorTool(rows){
  const seen = new Set(), out = [];
  for(const r of rows){
    const key = (r._vendor||'')+'|'+(r._tool||'')+'|'+(r._url||'');
    if(seen.has(key)) continue;
    seen.add(key); out.push(r);
  }
  return out;
}

function applyFilters(){
  if(!DATA.length){ toolsEl.innerHTML = '<div class="sub">Load a CSV to begin.</div>'; countEl.textContent=''; renderCharts([]); return; }
  const f = currentFilters();
  let rows = DATA.filter(r => matchRecord(r, f.text, f.vendor, f.region, f.cats));
  if (dedupeVendor.checked) rows = keyByVendorTool(rows);
  renderList(rows);
  renderCharts(rows);
}

function renderStars(id){
  const r = getRating(id);
  let html = '';
  for(let i=1;i<=5;i++){ html += `<span class="star ${i<=r?'on':''}" data-i="${i}">★</span>`; }
  return `<div class="stars" data-id="${id}">${html}</div>`;
}

function renderList(rows){
  countEl.textContent = `${rows.length} tools`;
  toolsEl.innerHTML = '';
  rows.slice(0, 200).forEach(rec=>{
    const url = rec._url ? `<a href="${rec._url}" target="_blank" rel="noopener">Open ↗</a>` : '';
    const chosen = compare.includes(rec.__id);
    const cats = (rec._categories||[]).map(c=>`<span class="chip" style="padding:2px 6px;font-size:11px">${esc(c)}</span>`).join(' ');
    const card = document.createElement('div');
    card.className='tool'; card.dataset.id = rec.__id;
    card.innerHTML = `
      <div class="title">${esc(rec.__display_name)}</div>
      <div class="meta">${esc(rec._vendor||'')} • <span>${esc(rec._region||'')}</span> ${url?('• '+url):''}</div>
      <div class="desc">${esc(rec._desc||'')}</div>
      <div class="row">${cats}</div>
      <div class="actions">
        <div>${renderStars(rec.__id)}</div>
        <div>
          <button class="btn btn-details">Details</button>
          <button class="btn btn-compare">${chosen?'Remove from compare':'Add to compare'}</button>
        </div>
      </div>
    `;
    toolsEl.appendChild(card);
  });

  // interactions
  toolsEl.querySelectorAll('.stars').forEach(st=>{
    const id = st.dataset.id;
    st.addEventListener('click', e=>{
      const s = e.target.closest('.star'); if(!s) return;
      setRating(id, parseInt(s.dataset.i,10)); applyFilters();
    });
  });
  toolsEl.querySelectorAll('.btn-details').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id = e.target.closest('.tool').dataset.id;
      const rec = DATA.find(r=>r.__id===id);
      renderDetails(rec);
    });
  });
  toolsEl.querySelectorAll('.btn-compare').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const id = e.target.closest('.tool').dataset.id;
      toggleCompare(id); applyFilters();
    });
  });
}

function renderDetails(rec){
  if(!rec){ detailsEl.textContent = 'No record'; return; }
  const rows = Object.keys(rec).filter(k => !k.startsWith('_')).map(k=>{
    const v = rec[k];
    if (v==null || v==='') return '';
    const val = /^https?:\/\//i.test(String(v)) ? `<a href="${v}" target="_blank" rel="noopener">${esc(v)}</a>` : esc(v);
    return `<tr><th>${esc(k)}</th><td>${val}</td></tr>`;
  }).join('');
  detailsEl.innerHTML = `<table class="compare">${rows}</table>`;
}

function renderCompare(){
  const list = document.getElementById('compareList');
  const tbl = document.getElementById('compareTable');
  list.innerHTML = '';
  if(!compare.length){ tbl.innerHTML = '<tr><td class="sub">Nothing selected</td></tr>'; return; }

  compare.forEach(id=>{
    const rec = DATA.find(r=>r.__id===id);
    const pill = document.createElement('div');
    pill.className='pill';
    pill.innerHTML = `<span>${esc(rec.__display_name)}</span> <span class="x" data-id="${id}">✕</span>`;
    list.appendChild(pill);
  });
  list.querySelectorAll('.x').forEach(x=>x.addEventListener('click',e=>{
    toggleCompare(e.target.dataset.id);
  }));

  const cols = COMP_FIELDS.length ? COMP_FIELDS : ['Vendor Name','Product Name','Tool','Website','Category','Tags','Region'];
  let html = '<tr><th>Field</th>' + compare.map(id=>'<th>'+esc(DATA.find(r=>r.__id===id).__display_name)+'</th>').join('') + '</tr>';
  for(const col of cols){
    html += '<tr><th>'+esc(col)+'</th>';
    for(const id of compare){
      const rec = DATA.find(r=>r.__id===id);
      let val = rec[col] ?? '';
      if (/^https?:\/\//i.test(String(val))) val = `<a href="${val}" target="_blank" rel="noopener">Open ↗</a>`;
      html += '<td>'+(val?esc(String(val)).replace(/(https?:\/\/\S+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>'):'')+'</td>';
    }
    html += '</tr>';
  }
  tbl.innerHTML = html;
}

/* ---------- Charts ---------- */
let chartCategory=null, chartVendor=null;
function renderCharts(rows){
  const byCat = new Map();
  (rows.length?rows:[]).forEach(r=>{
    const cats = r._categories && r._categories.length ? r._categories : ['—'];
    cats.forEach(c => byCat.set(c,(byCat.get(c)||0)+1));
  });
  const catLabels = Array.from(byCat.keys());
  const catVals = catLabels.map(k=>byCat.get(k));

  const byVendor = new Map();
  (rows.length?rows:[]).forEach(r=>{
    const v = r._vendor || '—';
    byVendor.set(v,(byVendor.get(v)||0)+1);
  });
  const vendPairs = Array.from(byVendor.entries()).sort((a,b)=>b[1]-a[1]).slice(0,12);
  const vendLabels = vendPairs.map(p=>p[0]);
  const vendVals = vendPairs.map(p=>p[1]);

  const ctx1 = document.getElementById('chartCategory').getContext('2d');
  const ctx2 = document.getElementById('chartVendor').getContext('2d');
  const opt1 = {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}};
  const opt2 = {responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{legend:{display:false}}};
  if(chartCategory) chartCategory.destroy();
  if(chartVendor) chartVendor.destroy();
  chartCategory = new Chart(ctx1, {type:'bar', data:{labels:catLabels, datasets:[{label:'Tools', data:catVals}]}, options:opt1});
  chartVendor   = new Chart(ctx2, {type:'bar', data:{labels:vendLabels, datasets:[{label:'Tools', data:vendVals}]}, options:opt2});
}

/* ---------- Wire up ---------- */
document.getElementById('loadBtn').onclick = ()=>document.getElementById('fileInput').click();
document.getElementById('fileInput').addEventListener('change', e=>{
  const file = e.target.files?.[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = () => loadCSVFromText(reader.result);
  reader.readAsText(file);
});
document.getElementById('pasteBtn').onclick = ()=>{
  const t = prompt("Paste CSV content here, then press OK.");
  if(t) loadCSVFromText(t);
};
document.getElementById('clearDetails').onclick = ()=>{ detailsEl.textContent = 'Select a tool to see full info.'; };

q.addEventListener('input', applyFilters);
vendorSel.addEventListener('change', applyFilters);
regionSel.addEventListener('change', applyFilters);
catRow.addEventListener('change', applyFilters);
dedupeVendor.addEventListener('change', applyFilters);

// Optional: keyboard nav for compare focus could be added here
</script>
</body>
</html>
